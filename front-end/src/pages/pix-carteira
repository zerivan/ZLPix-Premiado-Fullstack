import React, { useEffect, useRef, useState } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import NavBottom from "../components/navbottom";
import { api } from "../api/client";

type PixState = {
  paymentId: string;
  qr_code_base64?: string;
  copy_paste?: string;
  valor: number;
};

export default function PixCarteira() {
  const { state } = useLocation() as { state: PixState };
  const navigate = useNavigate();

  const paymentId = state?.paymentId;
  const qrBase64 = state?.qr_code_base64;
  const copyPaste = state?.copy_paste;
  const valor = state?.valor;

  const [status, setStatus] = useState("Aguardando pagamento...");
  const pollingRef = useRef<NodeJS.Timeout | null>(null);

  // 游 Prote칞칚o: se abrir direto sem state
  useEffect(() => {
    if (!paymentId || !valor) {
      navigate("/carteira", { replace: true });
    }
  }, [paymentId, valor, navigate]);

  // 游늶 Copiar PIX
  async function copiarPix() {
    if (!copyPaste) return;

    try {
      await navigator.clipboard.writeText(copyPaste);
      alert("C칩digo PIX copiado!");
    } catch {
      alert("N칚o foi poss칤vel copiar o c칩digo PIX.");
    }
  }

  // 游대 Polling de pagamento (carteira)
  useEffect(() => {
    if (!paymentId) return;

    pollingRef.current = setInterval(async () => {
      try {
        const res = await api.get(
          `/pix/payment-status/${paymentId}`
        );

        if (
          typeof res.data?.status === "string" &&
          res.data.status.toLowerCase() === "paid"
        ) {
          setStatus("Pagamento confirmado! 游꿀");

          if (pollingRef.current) {
            clearInterval(pollingRef.current);
          }

          setTimeout(() => {
            navigate("/carteira", { replace: true });
          }, 1500);
        }
      } catch {
        // erro silencioso (rede)
      }
    }, 4000);

    return () => {
      if (pollingRef.current) {
        clearInterval(pollingRef.current);
      }
    };
  }, [paymentId, navigate]);

  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-900 via-blue-800 to-green-800 text-white flex flex-col pb-24">
      <header className="text-center py-6 border-b border-white/10 shadow-md">
        <h1 className="text-2xl font-extrabold text-yellow-300">
          游눱 Pagamento PIX
        </h1>
        <p className="text-blue-100 text-sm mt-1">
          Dep칩sito na carteira
        </p>
      </header>

      <main className="flex-1 flex flex-col items-center px-6 pt-8 space-y-6 text-center">
        <p className="text-sm text-blue-100">{status}</p>

        <div className="bg-white/10 border border-white/20 rounded-2xl p-6 w-full max-w-md space-y-4">
          <p className="text-sm text-blue-100">
            Valor do dep칩sito
          </p>

          <p className="text-3xl font-extrabold text-yellow-300">
            R$ {Number(valor).toFixed(2)}
          </p>

          {qrBase64 && (
            <img
              src={`data:image/png;base64,${qrBase64}`}
              alt="QR Code PIX"
              className="mx-auto w-56 h-56 bg-white p-2 rounded-xl"
            />
          )}

          {copyPaste && (
            <>
              <textarea
                readOnly
                value={copyPaste}
                className="w-full p-3 rounded-xl text-xs text-black"
              />

              <button
                onClick={copiarPix}
                className="w-full py-3 rounded-xl bg-yellow-400 text-blue-900 font-bold"
              >
                游늶 Copiar c칩digo PIX
              </button>
            </>
          )}

          <p className="text-xs text-blue-100">
            Aguarde a confirma칞칚o autom치tica do pagamento.
          </p>
        </div>
      </main>

      <NavBottom />
    </div>
  );
}